# deps/build.jl
# using Pkg
# using Libdl

const REPO_URL = "https://github.com/cuddorg/cudd.git"
# const REPO_REF = "main"
const REPO_REF = "cudd-3.0.0"
const PREFIX   = joinpath(@__DIR__, "usr")
const LIBDIR   = joinpath(PREFIX, "lib")
const INCDIR   = joinpath(PREFIX, "include")
const SRCDIR   = joinpath(@__DIR__, "cudd-src")

const LIBNAME = Sys.iswindows() ? "cudd.dll" :
                Sys.isapple()  ? "libcudd.dylib" :
                                  "libcudd.so"

mkpath.( (PREFIX, LIBDIR, INCDIR) )
isdir(SRCDIR) && rm(SRCDIR; recursive=true, force=true)

run(`git clone --depth 1 --branch=$(REPO_REF) $(REPO_URL) $(SRCDIR)`)

cd(SRCDIR) do
    if !isfile("configure")
        run(`autoreconf -fi`)
    end
    run(`./configure --enable-shared --disable-static CFLAGS=-O3\ -fPIC --prefix=$(PREFIX)`)
    run(`make -j$(Sys.CPU_THREADS) ACLOCAL=aclocal AUTOMAKE=automake AUTOCONF=autoconf`)
    run(`make install ACLOCAL=aclocal AUTOMAKE=automake AUTOCONF=autoconf`)
end

open(joinpath(@__DIR__, "deps.jl"), "w") do io
    println(io, "# Auto-generated by deps/build.jl")
    println(io, "const libcudd_path = ", repr(joinpath(LIBDIR, LIBNAME)))
end

println("[MiniCUDD] built: ", joinpath(LIBDIR, LIBNAME))
